# Copyright 2023 Canonical Ltd.
# See LICENSE file for licensing details.
---
name: charmed-superset-rock
base: ubuntu@22.04
version: '2.1.0' # Semantic versioning for human readability
summary: Charmed Superset ROCK OCI
description: |
  Superset is fast, lightweight, intuitive, and loaded with options
  that make it easy for users of all skill sets to explore and 
  visualize their data.
license: Apache-2.0

platforms:
  amd64:

parts:
  superset:
    plugin: nil
    source: https://downloads.apache.org/superset/2.1.0/apache-superset-2.1.0-source.tar.gz
    # https://superset.apache.org/docs/installation/installing-superset-from-scratch/
    build-packages:
      - build-essential
      - wget
      - libsasl2-dev
      - libldap2-dev
      - libssl-dev
      - libffi-dev
      - default-libmysqlclient-dev
    build-environment:
      - APP_HOME: "/app"
      - SOURCE: "https://downloads.apache.org/superset/"
      - VERSION: "2.1.0"
    stage-packages:
      - python3.10
      - python3-venv
      - python3-pip
    override-build: |
      # make home directory
      mkdir -p ${APP_HOME}

      # apt-get update
      apt-get update; apt-get upgrade -y; apt-get autoremove --purge -y; apt-get clean -y

      # Download and unpack tar
      wget "${SOURCE}/${VERSION}/apache-superset-${VERSION}-source.tar.gz" -O superset.tar.gz
      tar -zxvf superset.tar.gz -C ${APP_HOME} --strip-components 1
      rm -rf superset.tar.gz

      # Install dependencies
      pip install cython<3.0.0 && pip install --no-build-isolation pyyaml==5.4.1
      pip install --upgrade setuptools pip
      cd ${APP_HOME}
      pip install --no-cache-dir -r requirements/base.txt
      # pip wheel --no-index -w wheelhouse apache-superset==2.1.0
      # pip install wheelhouse/apache_superset-2.1.0-py3-none-any.whl

      echo "2" > version.txt

      # Stage the Superset directories
      cd / && cp -r app "${CRAFT_PART_INSTALL}/app"
